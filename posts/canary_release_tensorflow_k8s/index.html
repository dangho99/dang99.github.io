<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Deploying TensorFlow model as Canary Releases Kubernetes and Istio | DangHH's Blog</title><meta name=keywords content="Kubernetes,Model Serving"><meta name=description content="Use Istio with Minikube and TensorFlow Serving to create canary deployments of TensorFlow machine learning models!"><meta name=author content="dangho99"><link rel=canonical href=https://dangho99.github.io/dang99.github.io//posts/canary_release_tensorflow_k8s/><link crossorigin=anonymous href=../../assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U+6hYRq/Ez/nm5vg=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=../../assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://dangho99.github.io/dang99.github.io//favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://dangho99.github.io/dang99.github.io//favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://dangho99.github.io/dang99.github.io//favicon-32x32.png><link rel=apple-touch-icon href=https://dangho99.github.io/dang99.github.io//apple-touch-icon.png><link rel=mask-icon href=https://dangho99.github.io/dang99.github.io//apple-touch-icon.png><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Deploying TensorFlow model as Canary Releases Kubernetes and Istio"><meta property="og:description" content="Use Istio with Minikube and TensorFlow Serving to create canary deployments of TensorFlow machine learning models!"><meta property="og:type" content="article"><meta property="og:url" content="https://dangho99.github.io/dang99.github.io//posts/canary_release_tensorflow_k8s/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-06T11:45:22-08:00"><meta property="article:modified_time" content="2022-12-06T11:45:22-08:00"><meta property="og:site_name" content="DangHH's blog - Software Engineering Tutorials"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deploying TensorFlow model as Canary Releases Kubernetes and Istio"><meta name=twitter:description content="Use Istio with Minikube and TensorFlow Serving to create canary deployments of TensorFlow machine learning models!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://dangho99.github.io/dang99.github.io//posts/"},{"@type":"ListItem","position":3,"name":"Deploying TensorFlow model as Canary Releases Kubernetes and Istio","item":"https://dangho99.github.io/dang99.github.io//posts/canary_release_tensorflow_k8s/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Deploying TensorFlow model as Canary Releases Kubernetes and Istio","name":"Deploying TensorFlow model as Canary Releases Kubernetes and Istio","description":"Use Istio with Minikube and TensorFlow Serving to create canary deployments of TensorFlow machine learning models!","keywords":["Kubernetes","Model Serving"],"articleBody":"Deploying TensorFlow model as Canary Releases Kubernetes and Istio In this lab, we will use Istio with Minikube and TensorFlow Serving to create canary deployments of TensorFlow machine learning models. More concretely, we will:\nPrepare a minikube cluster with the Istio add-on for TensorFlow Serving. Create a canary release of a TensorFlow model deployment. Configure various traffic splitting strategies. Suppose we have already with minikube cluster look like that below:\n$ minikube profile list |----------|-----------|---------|-------------|------|---------|---------|-------|--------| | Profile | VM Driver | Runtime | IP | Port | Version | Status | Nodes | Active | |----------|-----------|---------|-------------|------|---------|---------|-------|--------| | minikube | none | docker | 192.168.0.5 | 8443 | v1.24.3 | Running | 1 | * | |----------|-----------|---------|-------------|------|---------|---------|-------|--------| Let’s download istio from https://github.com/istio/istio/releases/ and extracting:\n$ wget https://github.com/istio/istio/releases/download/1.12.7/istio-1.12.7-linux-amd64.tar.gz $ tar zvxf istio-1.12.7-linux-amd64.tar.gz $ cd istio-1.12.7 \u0026\u0026 ls bin LICENSE manifests manifest.yaml README.md samples tools $ export PATH=$PWD/bin:$PATH $ istioctl install This will install the Istio 1.12.7 default profile with [\"Istio core\" \"Istiod\" \"Ingress gateways\"] components into the cluster. Proceed? (y/N) y ✔ Istio core installed ✔ Istiod installed- Processing resources for Ingress gateways. Waiting for Deployment/istio-system/istio-ingressgateway ✔ Ingress gateways installed ✔ Installation complete Making this installation the default for injection and validation. Now listing pods in istio-system namespace\n$ kubectl get pods -n istio-system NAME READY STATUS RESTARTS AGE istio-ingressgateway-58fbb84dfd-d79rj 1/1 Running 0 15m istiod-77f69cccd6-t9grw 1/1 Running 0 16m $ kubectl get svc -n istio-system istio-ingressgateway NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-ingressgateway LoadBalancer 10.110.24.130 15021:30487/TCP,80:30717/TCP,443:32359/TCP 24h Because my environment does not provide an external load balancer for the ingress gateway, so we see the EXTERNAL-IP have status. Let’s use minikube tunnel to fix this.\n$ minikube tunnel Status:\tmachine: minikube pid: 24042 route: 10.96.0.0/12 -\u003e 192.168.0.5 minikube: Running services: [istio-ingressgateway] errors: minikube: no errors router: no errors loadbalancer emulator: no errors $ kubectl get svc -n istio-system istio-ingressgateway NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-ingressgateway LoadBalancer 10.110.24.130 10.110.24.130 15021:30487/TCP,80:30717/TCP,443:32359/TCP 25h Create the tf-serving namespace and enable automatic proxy sidecar injection.\n$ kubectl create ns tf-serving namespace/tf-serving created $ kubectl label ns tf-serving istio-injection=enabled namespace/tf-serving labeled $ kubectl get ns --show-labels NAME STATUS AGE LABELS default Active 13d kubernetes.io/metadata.name=default istio-system Active 20m kubernetes.io/metadata.name=istio-system kube-flannel Active 13d kubernetes.io/metadata.name=kube-flannel,pod-security.kubernetes.io/enforce=privileged kube-node-lease Active 13d kubernetes.io/metadata.name=kube-node-lease kube-public Active 13d kubernetes.io/metadata.name=kube-public kube-system Active 13d kubernetes.io/metadata.name=kube-system tf-serving Active 57s istio-injection=enabled,kubernetes.io/metadata.name=tf-serving Download ResNet50 pretrained model using python code:\n\u003e\u003e\u003e import tensorflow as tf \u003e\u003e\u003e print(tf.__version__) 2.6.2 \u003e\u003e\u003e model = tf.keras.applications.resnet50.ResNet50() Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/resnet/resnet50_weights_tf_dim_ordering_tf_kernels.h5 102973440/102967424 [==============================] - 32s 0us/step \u003e\u003e\u003e model.save('/home/dangho/Downloads/resnet50/1') # 1 is version INFO:tensorflow:Assets written to: /home/dangho/Downloads/resnet50/1/assets So we have the ResNet50 pretrained model:\n$ ls -la resnet50/1/ total 4076 drwxrwxrwx 1 dangho dangho 4096 Thg 9 24 23:08 . drwxrwxrwx 1 dangho dangho 4096 Thg 9 24 22:56 .. drwxrwxrwx 1 dangho dangho 0 Thg 9 24 23:08 assets -rwxrwxrwx 1 dangho dangho 365902 Thg 9 24 23:08 keras_metadata.pb -rwxrwxrwx 1 dangho dangho 3796233 Thg 9 24 23:08 saved_model.pb drwxrwxrwx 1 dangho dangho 0 Thg 9 24 23:08 variables Creating ConfigMap configmap-resnet50.yaml:\napiVersion: v1 kind: ConfigMap metadata: name: resnet50-configs namespace: tf-serving data: MODEL_NAME: image_classifier MODEL_PATH: /models/resnet50 Using kubectl create the ConfigMap:\n$ kubectl apply -f configmap-resnet50.yaml configmap/resnet50-configs created Creating the deployment deployment-resnet50.yaml:\napiVersion: apps/v1 kind: Deployment metadata: name: image-classifier-resnet50 namespace: tf-serving labels: app: image-classifier version: resnet50 spec: replicas: 1 selector: matchLabels: app: image-classifier version: resnet50 template: metadata: labels: app: image-classifier version: resnet50 spec: containers: - name: tf-serving image: \"tensorflow/serving:2.5.1\" args: - \"--model_name=$(MODEL_NAME)\" - \"--model_base_path=$(MODEL_PATH)\" envFrom: - configMapRef: name: resnet50-configs imagePullPolicy: IfNotPresent ports: - name: http containerPort: 8501 protocol: TCP - name: grpc containerPort: 8500 protocol: TCP volumeMounts: - name: model mountPath: /models/resnet50 volumes: - name: model hostPath: path: /home/dangho/Downloads/resnet50 Create the deployment and inspect it:\n$ kubectl apply -f deployment-resnet50.yaml deployment.apps/image-classifier-resnet50 created $ kubectl get deployments.apps -n tf-serving NAME READY UP-TO-DATE AVAILABLE AGE image-classifier-resnet50 1/1 1 1 91s $ kubectl get pods -n tf-serving NAME READY STATUS RESTARTS AGE image-classifier-resnet50-8556494d8-q4qm7 2/2 Running 0 5s Notice that the deployment is annotated with two labels: app: image-classifier and version: resnet50. These labels will be the key when configuring Istio traffic routing.\nCreating the service manifest in service.yaml:\napiVersion: v1 kind: Service metadata: name: image-classifier namespace: tf-serving labels: app: image-classifier service: image-classifier spec: type: ClusterIP ports: - port: 8500 protocol: TCP name: tf-serving-grpc - port: 8501 protocol: TCP name: tf-serving-http selector: app: image-classifier The selector field refers to the app: image-classifier label. What it means is that the service will load balance across all pods annotated with this label. At this point these are the pods comprising the ResNet50 deployment. The service type is ClusterIP. The IP address exposed by the service is only visible within the cluster.\nCreate the service and inspect it:\n$ kubectl apply -f service.yaml service/image-classifier created $ kubectl get svc -n tf-serving NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE image-classifier ClusterIP 10.96.44.45 8500/TCP,8501/TCP 12s Now we use an Istio Ingress gateway to manage inbound and outbound traffic for your mesh.\nFirstly, configure the gateway to open port 80 for the HTTP traffic:\napiVersion: networking.istio.io/v1alpha3 kind: Gateway metadata: name: image-classifier-gateway namespace: tf-serving spec: selector: istio: ingressgateway servers: - port: number: 80 name: http protocol: HTTP hosts: - \"*\" $ kubectl apply -f gateway.yaml gateway.networking.istio.io/image-classifier-gateway created $ kubectl get gateways.networking.istio.io -n tf-serving NAME AGE image-classifier-gateway 1s At this point the gateway is running but your ResNet50 deployment is still not accessible from the outside of the cluster. We need to configure a virtual service.\nVirtual services, along with destination rules are the key building blocks of Istio’s traffic routing functionality. A virtual service lets you configure how requests are routed to a service within an Istio service mesh. Each virtual service consists of a set of routing rules that are evaluated in order, letting Istio match each given request to the virtual service to a specific real destination within the mesh.\nWe will start by configuring a virtual service that forwards all requests sent through the gateway on port 80 to the image-classifier service on port 8501.\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: image-classifier namespace: tf-serving spec: hosts: - \"*\" gateways: - image-classifier-gateway http: - route: - destination: host: image-classifier port: number: 8501 Recall that the image-classifier service is configured to load balance between pods annotated with the app: image-classifer label. As a result all requests sent to the gateway will be forwarded to the ResNet50 deployment.\n$ kubectl apply -f virtual-service.yaml virtualservice.networking.istio.io/image-classifier created Now we will test access to the ResNet50 model.\n$ kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 10.110.24.130 $ kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name==\"http2\")].port}' 80 Now we will generate the inputs of ResNet50 model from image:\n$ python3 gen_payload.py You will see the request-body.json file have created. Using curl or requests module in python3 command to send request to serving model.\n$ curl -d @request-body.json -X POST http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict { \"predictions\": [[ ... ] ] } \u003e\u003e\u003e import requests, json, numpy \u003e\u003e\u003e r = requests.post(url=\"http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict\", json=json.load(open(\"request-body.json\"))) \u003e\u003e\u003e res = r.json() \u003e\u003e\u003e preds = res['predictions'] \u003e\u003e\u003e pred = preds[0] \u003e\u003e\u003e print(len(pred)) 1000 # Because the classes is 1000 \u003e\u003e\u003e print((-numpy.array(pred)).argsort()[:10]) # Get top-10 max [667 457 906 610 834 796 841 652 620 465] Detailed class list is listed here https://deeplearning.cms.waikato.ac.nz/user-guide/class-maps/IMAGENET/. From the prediction, we can get the label:\n667: mortarboard 457: bow tie, bow-tie, bowtie 906: Windsor tie 610: jersey, T-shirt, tee shirt 834: suit, suit of clothes 796: ski mask 841: sweatshirt 652: military uniform 620: laptop, laptop computer 465: bulletproof vest We have deployed the ResNet50, now will deploy another model, it’s the ResNet101 model as a canary release. As in the case of the ResNet50 model, ResNet101 will be deployed as a Kubernetes Deployment annotated with the app label set to image-classifier. Recall that the image-classifier Kubernetes service is configured to load balance between pods that contain the app label set to this value and that the Istio virtual service is configured to forward all the traffic from the Istio Ingress gateway to the image-classifier service.\nIf you deployed ResNet101 without any changes to the Istio virtual service the incoming traffic would be load balanced across pods from both deployments using a round-robin strategy. To have a better control over which requests go to which deployment you need to configure a destination rule and modify the virtual service.\nIn this case, the destination rule configures two different subsets of the image-classifier service using the version label as a selector, in order to differentiate between ResNet50 and ResNet101 deployments:\napiVersion: networking.istio.io/v1alpha3 kind: DestinationRule metadata: name: image-classifier namespace: tf-serving spec: host: image-classifier subsets: - name: resnet101 labels: version: resnet101 - name: resnet50 labels: version: resnet50 To create the destination rule:\n$ kubectl apply -f destinationrule.yaml destinationrule.networking.istio.io/image-classifier created Recall that the ResNet50 deployment is annotated with two labels: app: image-classifier and version: resnet50. The ResNet101 deployment is also annotated with the same labels. The value of the app label is the same but the value of the version label is different:\napiVersion: apps/v1 kind: Deployment metadata: name: image-classifier-resnet101 namespace: tf-serving labels: app: image-classifier version: resnet101 spec: replicas: 1 selector: matchLabels: app: image-classifier version: resnet101 template: metadata: labels: app: image-classifier version: resnet101 spec: containers: - name: tf-serving image: \"tensorflow/serving:2.5.1\" args: - \"--model_name=$(MODEL_NAME)\" - \"--model_base_path=$(MODEL_PATH)\" envFrom: - configMapRef: name: resnet101-configs imagePullPolicy: IfNotPresent ports: - name: http containerPort: 8501 protocol: TCP - name: grpc containerPort: 8500 protocol: TCP volumeMounts: - name: model mountPath: /models/resnet101 volumes: - name: model hostPath: path: /home/dangho/Downloads/resnet101 The final step is to reconfigure the virtual service to use the destination rule.\nYou will start by modifying the virtual service to route all requests (100%) from the Ingress gateway to the resnet50 service subset:\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: image-classifier namespace: tf-serving spec: hosts: - \"*\" gateways: - image-classifier-gateway http: - route: - destination: host: image-classifier subset: resnet50 port: number: 8501 weight: 100 - destination: host: image-classifier subset: resnet101 port: number: 8501 weight: 0 To apply the changes:\n$ kubectl apply -f virtualservice-weight-100.yaml virtualservice.networking.istio.io/image-classifier configured Now deploy the ResNet101 model using the same process as for the ResNet50 model. Refer back to the steps above to the kubectl commands for applying updates to the configmaps and deployment configurations.\nBut we need to download the ResNet101 pretrained model using python code:\n\u003e\u003e\u003e import tensorflow as tf \u003e\u003e\u003e print(tf.__version__) 2.6.2 \u003e\u003e\u003e model = tf.keras.applications.resnet.ResNet101() Downloading data from https://storage.googleapis.com/tensorflow/keras-applications/resnet/resnet101_weights_tf_dim_ordering_tf_kernels.h5 179650560/179648224 [==============================] - 26s 0us/step \u003e\u003e\u003e model.save('/home/dangho/Downloads/resnet101/1') # 1 is version INFO:tensorflow:Assets written to: /home/dangho/Downloads/resnet101/1/assets Apply the manifest:\n$ kubectl apply -f configmap-resnet101.yaml configmap/resnet101-configs created $ kubectl apply -f deployment-resnet101.yaml deployment.apps/image-classifier-resnet101 created $ kubectl get deployments.apps -n tf-serving NAME READY UP-TO-DATE AVAILABLE AGE image-classifier-resnet101 1/1 1 1 41s image-classifier-resnet50 1/1 1 1 51s At this point the ResNet101 deployment is ready but the virtual service is configured to route all requests to ResNet50.\nVerify this by sending a few prediction requests:\n\u003e\u003e\u003e import requests, json, numpy \u003e\u003e\u003e pred = requests.post(url=\"http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict\", json=json.load(open(\"request-body.json\"))).json()['predictions'][0] \u003e\u003e\u003e print((-numpy.array(pred)).argsort()[:10]) [667 457 906 610 834 796 841 652 620 465] All requests return the same result.\nYou will now reconfigure the Istio virtual service to split the traffic between the ResNet50 and ResNet101 models using weighted load balancing - 70% requests will go to ResNet50 and 30% to ResNet101.\nThe manifest for the new configuration is in the virtualservice-weight-70.yaml file:\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: image-classifier namespace: tf-serving spec: hosts: - \"*\" gateways: - image-classifier-gateway http: - route: - destination: host: image-classifier subset: resnet50 port: number: 8501 weight: 70 - destination: host: image-classifier subset: resnet101 port: number: 8501 weight: 30 To apply the manifest:\n$ kubectl apply -f virtualservice-weight-70.yaml virtualservice.networking.istio.io/image-classifier configured Send a few more requests - more than 10:\n\u003e\u003e\u003e import requests, json, numpy \u003e\u003e\u003e pred = requests.post(url=\"http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict\", json=json.load(open(\"request-body.json\"))).json()['predictions'][0] \u003e\u003e\u003e print((-numpy.array(pred)).argsort()[:10]) [667 457 906 610 834 796 841 652 620 465] \u003e\u003e\u003e pred = requests.post(url=\"http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict\", json=json.load(open(\"request-body.json\"))).json()['predictions'][0] \u003e\u003e\u003e print((-numpy.array(pred)).argsort()[:10]) [906 667 834 400 457 652 451 465 841 917] Notice that responses are now different.\nAs an optional task, you will reconfigure the virtual service to route traffic to the canary deployment based on request headers. This approach allows a variety of scenarios, including routing requests from a specific group of users to the canary release. Assume that the request from the canary users will carry a custom header user-group. If this header is set to canary the requests will be routed to ResNet101.\nThe virtualservice-focused-routing.yaml manifest defines this configuration:\napiVersion: networking.istio.io/v1alpha3 kind: VirtualService metadata: name: image-classifier namespace: tf-serving spec: hosts: - \"*\" gateways: - image-classifier-gateway http: - match: - headers: user-group: exact: canary route: - destination: host: image-classifier subset: resnet101 port: number: 8501 - route: - destination: host: image-classifier subset: resnet50 port: number: 8501 The match field defines a matching pattern and the route that is used for the requests with the matching header.\nReconfigure the virtual service:\n$ kubectl apply -f virtualservice-focused-routing.yaml virtualservice.networking.istio.io/image-classifier configured Send a few requests without the user-group header:\n\u003e\u003e\u003e import requests, json, numpy \u003e\u003e\u003e pred = requests.post(url=\"http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict\", json=json.load(open(\"request-body.json\"))).json()['predictions'][0] \u003e\u003e\u003e print((-numpy.array(pred)).argsort()[:10]) [667 457 906 610 834 796 841 652 620 465] Notice that all of the responses are coming from the ResNet50 model.\nNow, send a few requests with the user-group header set to canary:\n\u003e\u003e\u003e import requests, json, numpy \u003e\u003e\u003e pred = requests.post(url=\"http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict\", json=json.load(open(\"request-body.json\")), headers={\"user-group\": \"canary\"}).json()['predictions'][0] \u003e\u003e\u003e print((-numpy.array(pred)).argsort()[:10]) [906 667 834 400 457 652 451 465 841 917] All of the responses are now sent by the ResNet101 model.\nThis deployment configuration can be used for A/B testing as you can easily monitor the performance of the canary model on a specific user group.\nYou can get full source code here!\n","wordCount":"2240","inLanguage":"en","datePublished":"2022-12-06T11:45:22-08:00","dateModified":"2022-12-06T11:45:22-08:00","author":[{"@type":"Person","name":"dangho99"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://dangho99.github.io/dang99.github.io//posts/canary_release_tensorflow_k8s/"},"publisher":{"@type":"Organization","name":"DangHH's Blog","logo":{"@type":"ImageObject","url":"https://dangho99.github.io/dang99.github.io//favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://dangho99.github.io/dang99.github.io/ accesskey=h title="DangHH's blog (Alt + H)">DangHH's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://dangho99.github.io/dang99.github.io//tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://dangho99.github.io/dang99.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://dangho99.github.io/dang99.github.io//posts/>Posts</a></div><h1 class=post-title>Deploying TensorFlow model as Canary Releases Kubernetes and Istio</h1><div class=post-description>Use Istio with Minikube and TensorFlow Serving to create canary deployments of TensorFlow machine learning models!</div><div class=post-meta><span title='2022-12-06 11:45:22 -0800 -0800'>December 6, 2022</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;2240 words&nbsp;·&nbsp;dangho99</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><ul><li><a href=#deploying-tensorflow-model-as-canary-releases-kubernetes-and-istio>Deploying TensorFlow model as Canary Releases Kubernetes and Istio</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h3 id=deploying-tensorflow-model-as-canary-releases-kubernetes-and-istio>Deploying TensorFlow model as Canary Releases Kubernetes and Istio<a hidden class=anchor aria-hidden=true href=#deploying-tensorflow-model-as-canary-releases-kubernetes-and-istio>#</a></h3><p>In this lab, we will use Istio with Minikube and TensorFlow Serving to create canary deployments of TensorFlow machine learning models. More concretely, we will:</p><ol><li>Prepare a minikube cluster with the Istio add-on for TensorFlow Serving.</li><li>Create a canary release of a TensorFlow model deployment.</li><li>Configure various traffic splitting strategies.</li></ol><p>Suppose we have already with minikube cluster look like that below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ minikube profile list
</span></span><span style=display:flex><span>|----------|-----------|---------|-------------|------|---------|---------|-------|--------|
</span></span><span style=display:flex><span>| Profile  | VM Driver | Runtime |     IP      | Port | Version | Status  | Nodes | Active |
</span></span><span style=display:flex><span>|----------|-----------|---------|-------------|------|---------|---------|-------|--------|
</span></span><span style=display:flex><span>| minikube | none      | docker  | 192.168.0.5 | <span style=color:#ae81ff>8443</span> | v1.24.3 | Running |     <span style=color:#ae81ff>1</span> | *      |
</span></span><span style=display:flex><span>|----------|-----------|---------|-------------|------|---------|---------|-------|--------|
</span></span></code></pre></div><p>Let&rsquo;s download istio from <a href=https://github.com/istio/istio/releases/>https://github.com/istio/istio/releases/</a> and extracting:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ wget https://github.com/istio/istio/releases/download/1.12.7/istio-1.12.7-linux-amd64.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ tar zvxf istio-1.12.7-linux-amd64.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cd istio-1.12.7 <span style=color:#f92672>&amp;&amp;</span> ls
</span></span><span style=display:flex><span>bin  LICENSE  manifests  manifest.yaml  README.md  samples  tools
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ export PATH<span style=color:#f92672>=</span>$PWD/bin:$PATH
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ istioctl install
</span></span><span style=display:flex><span>This will install the Istio 1.12.7 default profile with <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;Istio core&#34;</span> <span style=color:#e6db74>&#34;Istiod&#34;</span> <span style=color:#e6db74>&#34;Ingress gateways&#34;</span><span style=color:#f92672>]</span> components into the cluster. Proceed? <span style=color:#f92672>(</span>y/N<span style=color:#f92672>)</span> y
</span></span><span style=display:flex><span>✔ Istio core installed
</span></span><span style=display:flex><span>✔ Istiod installed- Processing resources <span style=color:#66d9ef>for</span> Ingress gateways. Waiting <span style=color:#66d9ef>for</span> Deployment/istio-system/istio-ingressgateway
</span></span><span style=display:flex><span>✔ Ingress gateways installed
</span></span><span style=display:flex><span>✔ Installation complete
</span></span><span style=display:flex><span>Making this installation the default <span style=color:#66d9ef>for</span> injection and validation.
</span></span></code></pre></div><p>Now listing pods in <code>istio-system</code> namespace</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl get pods -n istio-system
</span></span><span style=display:flex><span>NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>istio-ingressgateway-58fbb84dfd-d79rj   1/1     Running   <span style=color:#ae81ff>0</span>          15m
</span></span><span style=display:flex><span>istiod-77f69cccd6-t9grw                 1/1     Running   <span style=color:#ae81ff>0</span>          16m
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get svc -n istio-system istio-ingressgateway
</span></span><span style=display:flex><span>NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>                                      AGE
</span></span><span style=display:flex><span>istio-ingressgateway   LoadBalancer   10.110.24.130   &lt;pending&gt;     15021:30487/TCP,80:30717/TCP,443:32359/TCP   24h
</span></span></code></pre></div><p>Because my environment does not provide an external load balancer for the ingress gateway, so we see the <code>EXTERNAL-IP</code> have <code>&lt;pending></code> status. Let&rsquo;s use <code>minikube tunnel</code> to fix this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ minikube tunnel 
</span></span><span style=display:flex><span>Status:	
</span></span><span style=display:flex><span>	machine: minikube
</span></span><span style=display:flex><span>	pid: <span style=color:#ae81ff>24042</span>
</span></span><span style=display:flex><span>	route: 10.96.0.0/12 -&gt; 192.168.0.5
</span></span><span style=display:flex><span>	minikube: Running
</span></span><span style=display:flex><span>	services: <span style=color:#f92672>[</span>istio-ingressgateway<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    errors: 
</span></span><span style=display:flex><span>		minikube: no errors
</span></span><span style=display:flex><span>		router: no errors
</span></span><span style=display:flex><span>		loadbalancer emulator: no errors
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get svc -n istio-system istio-ingressgateway
</span></span><span style=display:flex><span>NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP     PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>                                      AGE
</span></span><span style=display:flex><span>istio-ingressgateway   LoadBalancer   10.110.24.130   10.110.24.130   15021:30487/TCP,80:30717/TCP,443:32359/TCP   25h
</span></span></code></pre></div><p>Create the <code>tf-serving</code> namespace and enable automatic proxy sidecar injection.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl create ns tf-serving
</span></span><span style=display:flex><span>namespace/tf-serving created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl label ns tf-serving istio-injection<span style=color:#f92672>=</span>enabled
</span></span><span style=display:flex><span>namespace/tf-serving labeled
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get ns --show-labels
</span></span><span style=display:flex><span>NAME              STATUS   AGE   LABELS
</span></span><span style=display:flex><span>default           Active   13d   kubernetes.io/metadata.name<span style=color:#f92672>=</span>default
</span></span><span style=display:flex><span>istio-system      Active   20m   kubernetes.io/metadata.name<span style=color:#f92672>=</span>istio-system
</span></span><span style=display:flex><span>kube-flannel      Active   13d   kubernetes.io/metadata.name<span style=color:#f92672>=</span>kube-flannel,pod-security.kubernetes.io/enforce<span style=color:#f92672>=</span>privileged
</span></span><span style=display:flex><span>kube-node-lease   Active   13d   kubernetes.io/metadata.name<span style=color:#f92672>=</span>kube-node-lease
</span></span><span style=display:flex><span>kube-public       Active   13d   kubernetes.io/metadata.name<span style=color:#f92672>=</span>kube-public
</span></span><span style=display:flex><span>kube-system       Active   13d   kubernetes.io/metadata.name<span style=color:#f92672>=</span>kube-system
</span></span><span style=display:flex><span>tf-serving        Active   57s   istio-injection<span style=color:#f92672>=</span>enabled,kubernetes.io/metadata.name<span style=color:#f92672>=</span>tf-serving
</span></span></code></pre></div><p>Download ResNet50 pretrained model using python code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> tensorflow <span style=color:#66d9ef>as</span> tf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(tf<span style=color:#f92672>.</span>__version__)
</span></span><span style=display:flex><span><span style=color:#ae81ff>2.6.2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> model <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>applications<span style=color:#f92672>.</span>resnet50<span style=color:#f92672>.</span>ResNet50()
</span></span><span style=display:flex><span>Downloading data <span style=color:#f92672>from</span> https:<span style=color:#f92672>//</span>storage<span style=color:#f92672>.</span>googleapis<span style=color:#f92672>.</span>com<span style=color:#f92672>/</span>tensorflow<span style=color:#f92672>/</span>keras<span style=color:#f92672>-</span>applications<span style=color:#f92672>/</span>resnet<span style=color:#f92672>/</span>resnet50_weights_tf_dim_ordering_tf_kernels<span style=color:#f92672>.</span>h5
</span></span><span style=display:flex><span><span style=color:#ae81ff>102973440</span><span style=color:#f92672>/</span><span style=color:#ae81ff>102967424</span> [<span style=color:#f92672>==============================</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>32</span>s <span style=color:#ae81ff>0</span>us<span style=color:#f92672>/</span>step
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> model<span style=color:#f92672>.</span>save(<span style=color:#e6db74>&#39;/home/dangho/Downloads/resnet50/1&#39;</span>) <span style=color:#75715e># 1 is version</span>
</span></span><span style=display:flex><span>INFO:tensorflow:Assets written to: <span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>dangho<span style=color:#f92672>/</span>Downloads<span style=color:#f92672>/</span>resnet50<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span><span style=color:#f92672>/</span>assets
</span></span></code></pre></div><p>So we have the ResNet50 pretrained model:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ls -la resnet50/1/
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>4076</span>
</span></span><span style=display:flex><span>drwxrwxrwx <span style=color:#ae81ff>1</span> dangho dangho    <span style=color:#ae81ff>4096</span> Thg <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>24</span> 23:08 .
</span></span><span style=display:flex><span>drwxrwxrwx <span style=color:#ae81ff>1</span> dangho dangho    <span style=color:#ae81ff>4096</span> Thg <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>24</span> 22:56 ..
</span></span><span style=display:flex><span>drwxrwxrwx <span style=color:#ae81ff>1</span> dangho dangho       <span style=color:#ae81ff>0</span> Thg <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>24</span> 23:08 assets
</span></span><span style=display:flex><span>-rwxrwxrwx <span style=color:#ae81ff>1</span> dangho dangho  <span style=color:#ae81ff>365902</span> Thg <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>24</span> 23:08 keras_metadata.pb
</span></span><span style=display:flex><span>-rwxrwxrwx <span style=color:#ae81ff>1</span> dangho dangho <span style=color:#ae81ff>3796233</span> Thg <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>24</span> 23:08 saved_model.pb
</span></span><span style=display:flex><span>drwxrwxrwx <span style=color:#ae81ff>1</span> dangho dangho       <span style=color:#ae81ff>0</span> Thg <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>24</span> 23:08 variables
</span></span></code></pre></div><p>Creating ConfigMap <code>configmap-resnet50.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>ConfigMap</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>resnet50-configs</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span><span style=color:#f92672>data</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>MODEL_NAME</span>: <span style=color:#ae81ff>image_classifier</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>MODEL_PATH</span>: <span style=color:#ae81ff>/models/resnet50</span>
</span></span></code></pre></div><p>Using <code>kubectl</code> create the ConfigMap:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f configmap-resnet50.yaml
</span></span><span style=display:flex><span>configmap/resnet50-configs created
</span></span></code></pre></div><p>Creating the deployment <code>deployment-resnet50.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image-classifier-resnet50</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>resnet50</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>resnet50</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>version</span>: <span style=color:#ae81ff>resnet50</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;tensorflow/serving:2.5.1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>args</span>: 
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;--model_name=$(MODEL_NAME)&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;--model_base_path=$(MODEL_PATH)&#34;</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>envFrom</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>configMapRef</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>resnet50-configs</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8501</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>grpc</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8500</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>model</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/models/resnet50</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>model</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>hostPath</span>: 
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/dangho/Downloads/resnet50</span>
</span></span></code></pre></div><p>Create the deployment and inspect it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f deployment-resnet50.yaml 
</span></span><span style=display:flex><span>deployment.apps/image-classifier-resnet50 created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get deployments.apps -n tf-serving 
</span></span><span style=display:flex><span>NAME                        READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>image-classifier-resnet50   1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           91s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get pods -n tf-serving 
</span></span><span style=display:flex><span>NAME                                        READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>image-classifier-resnet50-8556494d8-q4qm7   2/2     Running   <span style=color:#ae81ff>0</span>          5s
</span></span></code></pre></div><p>Notice that the deployment is annotated with two labels: <code>app: image-classifier</code> and <code>version: resnet50</code>. These labels will be the key when configuring Istio traffic routing.</p><p>Creating the service manifest in <code>service.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Service</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>service</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>type</span>: <span style=color:#ae81ff>ClusterIP</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8500</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tf-serving-grpc</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>: <span style=color:#ae81ff>8501</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tf-serving-http</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span></code></pre></div><p>The selector field refers to the <code>app: image-classifier</code> label. What it means is that the service will load balance across all pods annotated with this label. At this point these are the pods comprising the ResNet50 deployment. The service type is <code>ClusterIP</code>. The IP address exposed by the service is only visible within the cluster.</p><p>Create the service and inspect it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f service.yaml
</span></span><span style=display:flex><span>service/image-classifier created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get svc -n tf-serving 
</span></span><span style=display:flex><span>NAME               TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style=color:#f92672>(</span>S<span style=color:#f92672>)</span>             AGE
</span></span><span style=display:flex><span>image-classifier   ClusterIP   10.96.44.45   &lt;none&gt;        8500/TCP,8501/TCP   12s
</span></span></code></pre></div><p>Now we use an Istio Ingress gateway to manage inbound and outbound traffic for your mesh.</p><p>Firstly, configure the gateway to open port <code>80</code> for the <code>HTTP</code> traffic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Gateway</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image-classifier-gateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>istio</span>: <span style=color:#ae81ff>ingressgateway </span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>servers</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>number</span>: <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>HTTP</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f gateway.yaml
</span></span><span style=display:flex><span>gateway.networking.istio.io/image-classifier-gateway created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get gateways.networking.istio.io -n tf-serving 
</span></span><span style=display:flex><span>NAME                       AGE
</span></span><span style=display:flex><span>image-classifier-gateway   1s
</span></span></code></pre></div><p>At this point the gateway is running but your ResNet50 deployment is still not accessible from the outside of the cluster. We need to configure a virtual service.</p><p><code>Virtual services</code>, along with destination rules are the key building blocks of Istio&rsquo;s traffic routing functionality. A virtual service lets you configure how requests are routed to a service within an Istio service mesh. Each virtual service consists of a set of routing rules that are evaluated in order, letting Istio match each given request to the virtual service to a specific real destination within the mesh.</p><p>We will start by configuring a virtual service that forwards all requests sent through the gateway on port <code>80</code> to the <code>image-classifier</code> service on port <code>8501</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>image-classifier-gateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>number</span>: <span style=color:#ae81ff>8501</span>
</span></span></code></pre></div><p>Recall that the <code>image-classifier</code> service is configured to load balance between pods annotated with the <code>app: image-classifer</code> label. As a result all requests sent to the gateway will be forwarded to the ResNet50 deployment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f virtual-service.yaml 
</span></span><span style=display:flex><span>virtualservice.networking.istio.io/image-classifier created
</span></span></code></pre></div><p>Now we will test access to the ResNet50 model.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl -n istio-system get service istio-ingressgateway -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.status.loadBalancer.ingress[0].ip}&#39;</span>
</span></span><span style=display:flex><span>10.110.24.130
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl -n istio-system get service istio-ingressgateway -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;{.spec.ports[?(@.name==&#34;http2&#34;)].port}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>80</span>
</span></span></code></pre></div><p>Now we will generate the inputs of ResNet50 model from image:</p><p><img loading=lazy src=test.jpeg alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ python3 gen_payload.py
</span></span></code></pre></div><p>You will see the <code>request-body.json</code> file have created. Using <code>curl</code> or requests module in python3 command to send request to serving model.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ curl -d @request-body.json -X POST http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;predictions&#34;</span>: <span style=color:#f92672>[[</span>
</span></span><span style=display:flex><span>      ...
</span></span><span style=display:flex><span>      <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> requests<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> numpy
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> r <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict&#34;</span>,
</span></span><span style=display:flex><span>                      json<span style=color:#f92672>=</span>json<span style=color:#f92672>.</span>load(open(<span style=color:#e6db74>&#34;request-body.json&#34;</span>)))
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> res <span style=color:#f92672>=</span> r<span style=color:#f92672>.</span>json()
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> preds <span style=color:#f92672>=</span> res[<span style=color:#e6db74>&#39;predictions&#39;</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> pred <span style=color:#f92672>=</span> preds[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(len(pred))
</span></span><span style=display:flex><span><span style=color:#ae81ff>1000</span> <span style=color:#75715e># Because the classes is 1000</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print((<span style=color:#f92672>-</span>numpy<span style=color:#f92672>.</span>array(pred))<span style=color:#f92672>.</span>argsort()[:<span style=color:#ae81ff>10</span>]) <span style=color:#75715e># Get top-10 max</span>
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>667</span> <span style=color:#ae81ff>457</span> <span style=color:#ae81ff>906</span> <span style=color:#ae81ff>610</span> <span style=color:#ae81ff>834</span> <span style=color:#ae81ff>796</span> <span style=color:#ae81ff>841</span> <span style=color:#ae81ff>652</span> <span style=color:#ae81ff>620</span> <span style=color:#ae81ff>465</span>]
</span></span></code></pre></div><p>Detailed class list is listed here <a href=https://deeplearning.cms.waikato.ac.nz/user-guide/class-maps/IMAGENET/>https://deeplearning.cms.waikato.ac.nz/user-guide/class-maps/IMAGENET/</a>. From the prediction, we can get the label:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>667: mortarboard
</span></span><span style=display:flex><span>457: bow tie, bow-tie, bowtie
</span></span><span style=display:flex><span>906: Windsor tie
</span></span><span style=display:flex><span>610: jersey, T-shirt, tee shirt
</span></span><span style=display:flex><span>834: suit, suit of clothes
</span></span><span style=display:flex><span>796: ski mask
</span></span><span style=display:flex><span>841: sweatshirt
</span></span><span style=display:flex><span>652: military uniform
</span></span><span style=display:flex><span>620: laptop, laptop computer
</span></span><span style=display:flex><span>465: bulletproof vest
</span></span></code></pre></div><p>We have deployed the ResNet50, now will deploy another model, it&rsquo;s the ResNet101 model as a canary release. As in the case of the ResNet50 model, ResNet101 will be deployed as a Kubernetes Deployment annotated with the <code>app</code> label set to <code>image-classifier</code>. Recall that the <code>image-classifier</code> Kubernetes service is configured to load balance between pods that contain the <code>app</code> label set to this value and that the Istio virtual service is configured to forward all the traffic from the Istio Ingress gateway to the <code>image-classifier</code> service.</p><p>If you deployed ResNet101 without any changes to the Istio virtual service the incoming traffic would be load balanced across pods from both deployments using a <code>round-robin</code> strategy. To have a better control over which requests go to which deployment you need to configure a <code>destination rule</code> and modify the virtual service.</p><p>In this case, the destination rule configures two different subsets of the <code>image-classifier</code> service using the version label as a selector, in order to differentiate between ResNet50 and ResNet101 deployments:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>DestinationRule</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>host</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>subsets</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>resnet101</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>resnet101</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>resnet50</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>resnet50</span>
</span></span></code></pre></div><p>To create the destination rule:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f destinationrule.yaml
</span></span><span style=display:flex><span>destinationrule.networking.istio.io/image-classifier created
</span></span></code></pre></div><p>Recall that the ResNet50 deployment is annotated with two labels: app: image-classifier and version: resnet50. The ResNet101 deployment is also annotated with the same labels. The value of the app label is the same but the value of the version label is different:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image-classifier-resnet101</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>resnet101</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>selector</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>matchLabels</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>app</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>version</span>: <span style=color:#ae81ff>resnet101</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>template</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>version</span>: <span style=color:#ae81ff>resnet101</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#34;tensorflow/serving:2.5.1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>args</span>: 
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;--model_name=$(MODEL_NAME)&#34;</span>
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;--model_base_path=$(MODEL_PATH)&#34;</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>envFrom</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>configMapRef</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>resnet101-configs</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>IfNotPresent</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>http</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8501</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>grpc</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>8500</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>protocol</span>: <span style=color:#ae81ff>TCP</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>volumeMounts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>model</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>mountPath</span>: <span style=color:#ae81ff>/models/resnet101</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>model</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>hostPath</span>: 
</span></span><span style=display:flex><span>          <span style=color:#f92672>path</span>: <span style=color:#ae81ff>/home/dangho/Downloads/resnet101</span>
</span></span></code></pre></div><p>The final step is to reconfigure the virtual service to use the destination rule.</p><p>You will start by modifying the virtual service to route all requests (100%) from the Ingress gateway to the resnet50 service subset:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>image-classifier-gateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>resnet50</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>number</span>: <span style=color:#ae81ff>8501</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>resnet101</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>number</span>: <span style=color:#ae81ff>8501</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>To apply the changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f virtualservice-weight-100.yaml
</span></span><span style=display:flex><span>virtualservice.networking.istio.io/image-classifier configured
</span></span></code></pre></div><p>Now deploy the ResNet101 model using the same process as for the ResNet50 model. Refer back to the steps above to the <code>kubectl</code> commands for applying updates to the configmaps and deployment configurations.</p><p>But we need to download the ResNet101 pretrained model using python code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> tensorflow <span style=color:#66d9ef>as</span> tf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print(tf<span style=color:#f92672>.</span>__version__)
</span></span><span style=display:flex><span><span style=color:#ae81ff>2.6.2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> model <span style=color:#f92672>=</span> tf<span style=color:#f92672>.</span>keras<span style=color:#f92672>.</span>applications<span style=color:#f92672>.</span>resnet<span style=color:#f92672>.</span>ResNet101()
</span></span><span style=display:flex><span>Downloading data <span style=color:#f92672>from</span> https:<span style=color:#f92672>//</span>storage<span style=color:#f92672>.</span>googleapis<span style=color:#f92672>.</span>com<span style=color:#f92672>/</span>tensorflow<span style=color:#f92672>/</span>keras<span style=color:#f92672>-</span>applications<span style=color:#f92672>/</span>resnet<span style=color:#f92672>/</span>resnet101_weights_tf_dim_ordering_tf_kernels<span style=color:#f92672>.</span>h5
</span></span><span style=display:flex><span><span style=color:#ae81ff>179650560</span><span style=color:#f92672>/</span><span style=color:#ae81ff>179648224</span> [<span style=color:#f92672>==============================</span>] <span style=color:#f92672>-</span> <span style=color:#ae81ff>26</span>s <span style=color:#ae81ff>0</span>us<span style=color:#f92672>/</span>step
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> model<span style=color:#f92672>.</span>save(<span style=color:#e6db74>&#39;/home/dangho/Downloads/resnet101/1&#39;</span>) <span style=color:#75715e># 1 is version</span>
</span></span><span style=display:flex><span>INFO:tensorflow:Assets written to: <span style=color:#f92672>/</span>home<span style=color:#f92672>/</span>dangho<span style=color:#f92672>/</span>Downloads<span style=color:#f92672>/</span>resnet101<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span><span style=color:#f92672>/</span>assets
</span></span></code></pre></div><p>Apply the manifest:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f configmap-resnet101.yaml
</span></span><span style=display:flex><span>configmap/resnet101-configs created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl apply -f deployment-resnet101.yaml 
</span></span><span style=display:flex><span>deployment.apps/image-classifier-resnet101 created
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ kubectl get deployments.apps -n tf-serving 
</span></span><span style=display:flex><span>NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>image-classifier-resnet101   1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           41s
</span></span><span style=display:flex><span>image-classifier-resnet50    1/1     <span style=color:#ae81ff>1</span>            <span style=color:#ae81ff>1</span>           51s
</span></span></code></pre></div><p>At this point the ResNet101 deployment is ready but the virtual service is configured to route all requests to ResNet50.</p><p>Verify this by sending a few prediction requests:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> requests<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> numpy
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> pred <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict&#34;</span>,
</span></span><span style=display:flex><span>                         json<span style=color:#f92672>=</span>json<span style=color:#f92672>.</span>load(open(<span style=color:#e6db74>&#34;request-body.json&#34;</span>)))<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#39;predictions&#39;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print((<span style=color:#f92672>-</span>numpy<span style=color:#f92672>.</span>array(pred))<span style=color:#f92672>.</span>argsort()[:<span style=color:#ae81ff>10</span>])
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>667</span> <span style=color:#ae81ff>457</span> <span style=color:#ae81ff>906</span> <span style=color:#ae81ff>610</span> <span style=color:#ae81ff>834</span> <span style=color:#ae81ff>796</span> <span style=color:#ae81ff>841</span> <span style=color:#ae81ff>652</span> <span style=color:#ae81ff>620</span> <span style=color:#ae81ff>465</span>]
</span></span></code></pre></div><p>All requests return the same result.</p><p>You will now reconfigure the Istio virtual service to split the traffic between the ResNet50 and ResNet101 models using weighted load balancing - 70% requests will go to ResNet50 and 30% to ResNet101.</p><p>The manifest for the new configuration is in the <code>virtualservice-weight-70.yaml</code> file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>image-classifier-gateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>resnet50</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>number</span>: <span style=color:#ae81ff>8501</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>70</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>resnet101</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>number</span>: <span style=color:#ae81ff>8501</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>30</span>
</span></span></code></pre></div><p>To apply the manifest:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f virtualservice-weight-70.yaml
</span></span><span style=display:flex><span>virtualservice.networking.istio.io/image-classifier configured
</span></span></code></pre></div><p>Send a few more requests - more than 10:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> requests<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> numpy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> pred <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict&#34;</span>,
</span></span><span style=display:flex><span>                         json<span style=color:#f92672>=</span>json<span style=color:#f92672>.</span>load(open(<span style=color:#e6db74>&#34;request-body.json&#34;</span>)))<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#39;predictions&#39;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print((<span style=color:#f92672>-</span>numpy<span style=color:#f92672>.</span>array(pred))<span style=color:#f92672>.</span>argsort()[:<span style=color:#ae81ff>10</span>])
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>667</span> <span style=color:#ae81ff>457</span> <span style=color:#ae81ff>906</span> <span style=color:#ae81ff>610</span> <span style=color:#ae81ff>834</span> <span style=color:#ae81ff>796</span> <span style=color:#ae81ff>841</span> <span style=color:#ae81ff>652</span> <span style=color:#ae81ff>620</span> <span style=color:#ae81ff>465</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> pred <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict&#34;</span>,
</span></span><span style=display:flex><span>                         json<span style=color:#f92672>=</span>json<span style=color:#f92672>.</span>load(open(<span style=color:#e6db74>&#34;request-body.json&#34;</span>)))<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#39;predictions&#39;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print((<span style=color:#f92672>-</span>numpy<span style=color:#f92672>.</span>array(pred))<span style=color:#f92672>.</span>argsort()[:<span style=color:#ae81ff>10</span>])
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>906</span> <span style=color:#ae81ff>667</span> <span style=color:#ae81ff>834</span> <span style=color:#ae81ff>400</span> <span style=color:#ae81ff>457</span> <span style=color:#ae81ff>652</span> <span style=color:#ae81ff>451</span> <span style=color:#ae81ff>465</span> <span style=color:#ae81ff>841</span> <span style=color:#ae81ff>917</span>]
</span></span></code></pre></div><p>Notice that responses are now different.</p><p>As an optional task, you will reconfigure the virtual service to route traffic to the canary deployment based on request headers. This approach allows a variety of scenarios, including routing requests from a specific group of users to the canary release. Assume that the request from the canary users will carry a custom header user-group. If this header is set to canary the requests will be routed to ResNet101.</p><p>The <code>virtualservice-focused-routing.yaml</code> manifest defines this configuration:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>networking.istio.io/v1alpha3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>VirtualService</span>
</span></span><span style=display:flex><span><span style=color:#f92672>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>tf-serving</span>
</span></span><span style=display:flex><span><span style=color:#f92672>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>:
</span></span><span style=display:flex><span>  - <span style=color:#e6db74>&#34;*&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>gateways</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>image-classifier-gateway</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>http</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>headers</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>user-group</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>exact</span>: <span style=color:#ae81ff>canary</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>host</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>resnet101</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>number</span>: <span style=color:#ae81ff>8501</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>destination</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>image-classifier</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>subset</span>: <span style=color:#ae81ff>resnet50</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>port</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>number</span>: <span style=color:#ae81ff>8501</span>
</span></span></code></pre></div><p>The match field defines a matching pattern and the route that is used for the requests with the matching header.</p><p>Reconfigure the virtual service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ kubectl apply -f virtualservice-focused-routing.yaml
</span></span><span style=display:flex><span>virtualservice.networking.istio.io/image-classifier configured
</span></span></code></pre></div><p>Send a few requests without the <code>user-group</code> header:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> requests<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> numpy
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> pred <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict&#34;</span>,
</span></span><span style=display:flex><span>                         json<span style=color:#f92672>=</span>json<span style=color:#f92672>.</span>load(open(<span style=color:#e6db74>&#34;request-body.json&#34;</span>)))<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#39;predictions&#39;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print((<span style=color:#f92672>-</span>numpy<span style=color:#f92672>.</span>array(pred))<span style=color:#f92672>.</span>argsort()[:<span style=color:#ae81ff>10</span>])
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>667</span> <span style=color:#ae81ff>457</span> <span style=color:#ae81ff>906</span> <span style=color:#ae81ff>610</span> <span style=color:#ae81ff>834</span> <span style=color:#ae81ff>796</span> <span style=color:#ae81ff>841</span> <span style=color:#ae81ff>652</span> <span style=color:#ae81ff>620</span> <span style=color:#ae81ff>465</span>]
</span></span></code></pre></div><p>Notice that all of the responses are coming from the ResNet50 model.</p><p>Now, send a few requests with the <code>user-group</code> header set to <code>canary</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#f92672>import</span> requests<span style=color:#f92672>,</span> json<span style=color:#f92672>,</span> numpy
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> pred <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://10.110.24.130:80/v1/models/image_classifier/versions/1:predict&#34;</span>,
</span></span><span style=display:flex><span>                         json<span style=color:#f92672>=</span>json<span style=color:#f92672>.</span>load(open(<span style=color:#e6db74>&#34;request-body.json&#34;</span>)),
</span></span><span style=display:flex><span>                         headers<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;user-group&#34;</span>: <span style=color:#e6db74>&#34;canary&#34;</span>})<span style=color:#f92672>.</span>json()[<span style=color:#e6db74>&#39;predictions&#39;</span>][<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span><span style=color:#f92672>&gt;&gt;&gt;</span> print((<span style=color:#f92672>-</span>numpy<span style=color:#f92672>.</span>array(pred))<span style=color:#f92672>.</span>argsort()[:<span style=color:#ae81ff>10</span>])
</span></span><span style=display:flex><span>[<span style=color:#ae81ff>906</span> <span style=color:#ae81ff>667</span> <span style=color:#ae81ff>834</span> <span style=color:#ae81ff>400</span> <span style=color:#ae81ff>457</span> <span style=color:#ae81ff>652</span> <span style=color:#ae81ff>451</span> <span style=color:#ae81ff>465</span> <span style=color:#ae81ff>841</span> <span style=color:#ae81ff>917</span>]
</span></span></code></pre></div><p>All of the responses are now sent by the ResNet101 model.</p><p>This deployment configuration can be used for A/B testing as you can easily monitor the performance of the canary model on a specific user group.</p><p>You can get full source code <a href=https://github.com/dangho99/mlops-lab-practices/tree/main/canary-release-tensorflow-k8s>here</a>!</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://dangho99.github.io/dang99.github.io//tags/kubernetes/>Kubernetes</a></li><li><a href=https://dangho99.github.io/dang99.github.io//tags/model-serving/>Model Serving</a></li></ul><nav class=paginav><a class=next href=https://dangho99.github.io/dang99.github.io//posts/tensorflow_serving_configuration/><span class=title>Next »</span><br><span>Prepare and Deploy a TensorFlow Model to Tensorflow Serving</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Deploying TensorFlow model as Canary Releases Kubernetes and Istio on x" href="https://x.com/intent/tweet/?text=Deploying%20TensorFlow%20model%20as%20Canary%20Releases%20Kubernetes%20and%20Istio&amp;url=https%3a%2f%2fdangho99.github.io%2fposts%2fcanary_release_tensorflow_k8s%2f&amp;hashtags=Kubernetes%2cModelServing"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying TensorFlow model as Canary Releases Kubernetes and Istio on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fdangho99.github.io%2fposts%2fcanary_release_tensorflow_k8s%2f&amp;title=Deploying%20TensorFlow%20model%20as%20Canary%20Releases%20Kubernetes%20and%20Istio&amp;summary=Deploying%20TensorFlow%20model%20as%20Canary%20Releases%20Kubernetes%20and%20Istio&amp;source=https%3a%2f%2fdangho99.github.io%2fposts%2fcanary_release_tensorflow_k8s%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying TensorFlow model as Canary Releases Kubernetes and Istio on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fdangho99.github.io%2fposts%2fcanary_release_tensorflow_k8s%2f&title=Deploying%20TensorFlow%20model%20as%20Canary%20Releases%20Kubernetes%20and%20Istio"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying TensorFlow model as Canary Releases Kubernetes and Istio on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fdangho99.github.io%2fposts%2fcanary_release_tensorflow_k8s%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying TensorFlow model as Canary Releases Kubernetes and Istio on whatsapp" href="https://api.whatsapp.com/send?text=Deploying%20TensorFlow%20model%20as%20Canary%20Releases%20Kubernetes%20and%20Istio%20-%20https%3a%2f%2fdangho99.github.io%2fposts%2fcanary_release_tensorflow_k8s%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying TensorFlow model as Canary Releases Kubernetes and Istio on telegram" href="https://telegram.me/share/url?text=Deploying%20TensorFlow%20model%20as%20Canary%20Releases%20Kubernetes%20and%20Istio&amp;url=https%3a%2f%2fdangho99.github.io%2fposts%2fcanary_release_tensorflow_k8s%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Deploying TensorFlow model as Canary Releases Kubernetes and Istio on ycombinator" href="https://news.ycombinator.com/submitlink?t=Deploying%20TensorFlow%20model%20as%20Canary%20Releases%20Kubernetes%20and%20Istio&u=https%3a%2f%2fdangho99.github.io%2fposts%2fcanary_release_tensorflow_k8s%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://dangho99.github.io/dang99.github.io/>DangHH's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>